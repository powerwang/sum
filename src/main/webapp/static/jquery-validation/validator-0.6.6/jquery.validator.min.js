(function(e,t){"use strict";function H(t,r){var i=this,s,o;if(!i instanceof H)return new H(t,r);N(r)&&(r={valid:r}),r=r||{},o=O(t,"data-"+n+"-option"),o=o&&o.charAt(0)==="{"?(new Function("return "+o))():{},s=P[r.theme||o.theme||D.theme],i.options=e.extend({},D,s,o,r),i.$el=e(t),i.rules=new B(i.options.rules,!0),i.messages=new j(i.options.messages,!0),i.elements={},i.fields={},i.deferred={},i.errors={},i._init()}function B(e,t){var n=t?t===!0?this:t:B.prototype;if(!L(e))return;for(var r in e)n[r]=F(e[r])}function j(e,t){var n=t?t===!0?this:t:j.prototype;if(!L(e))return;for(var r in e){if(!e[r])return;n[r]=e[r]}}function F(t){switch(e.type(t)){case"function":return t;case"array":return function(e){return t[0].test(e.value)||t[1]||!1};case"regexp":return function(e){return t.test(e.value)}}}function I(t){var n="";return e.map(t.split(" "),function(e){n+=","+(e.charAt(0)==="#"?e:'[name="'+e+'"]')}),n.substring(1)}function q(t){var r;if(!t||!t.tagName)return;switch(t.tagName){case"INPUT":case"SELECT":case"TEXTAREA":case"BUTTON":case"FIELDSET":r=t.form||e(t).closest(".n-"+n);break;case"FORM":r=t;break;default:r=e(t).closest(".n-"+n)}return e(r).data(n)||e(r)[n]().data(n)}function R(t,n){if(!t.form||O(t.form,v)!==null)return;var r=q(t);r?(r._parse(t),e(t).trigger(n)):O(t,c,null)}function U(t,n){var r=e.trim(O(t,c+"-"+n));if(!r)return;r=(new Function("return "+r))();if(r)return F(r)}function z(e,t,n){var r=t.msg;return L(r)&&n&&(r=r[n]),k(r)||(r=O(e,"data-msg-"+n)||O(e,"data-msg")||""),r}function W(e){var t;return e&&(t=w.exec(e)),t?t[1]:""}function X(e){return e.tagName==="INPUT"&&e.type==="checkbox"||e.type==="radio"}function V(e){return Date.parse(e.replace(/\.|\-/g,"/"))}var n="validator",r="n-ok",i="n-error",s="n-tip",o="n-loading",u="n-valid",a="n-invalid",f="msg-box",l="aria-invalid",c="data-rule",h="data-target",p="data-tip",d="data-inputstatus",v="novalidate",m=":verifiable",g=/(\w+)(?:\[(.*)\]$|\((.*)\)$)?/,y=/(?:([^:;\(\[]*):)?(.*)/,b=/[^\x00-\xff]/g,w=/^.*(top|right|bottom|left).*$/,E=/(?:(post|get):)?(.+)/i,S=/<|>/g,x=e.noop,T=e.proxy,N=e.isFunction,C=e.isArray,k=function(e){return typeof e=="string"},L=function(e){return e&&Object.prototype.toString.call(e)==="[object Object]"},A=!window.XMLHttpRequest,O=function(e,n,r){if(r===t)return e.getAttribute(n);r===null?e.removeAttribute(n):e.setAttribute(n,""+r)},M=window.console||{log:x,info:x},_,D={debug:0,timely:1,theme:"default",stopOnError:!1,ignore:"",msgWrapper:"span",msgMaker:function(e){var t,n={error:i,ok:r,tip:s,loading:o}[e.type];return t='<span class="msg-wrap '+n+'" role="alert">',t+=(e.arrow||"")+(e.icon||"")+'<span class="n-msg">'+e.msg+"</span>",t+="</span>",t},msgIcon:'<span class="n-icon"></span>',msgArrow:"",msgClass:"",defaultMsg:"{0} is not valid.",loadingMsg:"Validating..."},P={"default":{formClass:"n-default",msgClass:"n-right",showOk:""}};e.fn[n]=function(t){var r=this,i=arguments;return r.is(":input")?r:(!r.is("form")&&(r=this.find("form")),!r.length&&(r=this),r.each(function(){if(k(t)){if(t.charAt(0)==="_")return;var r=e(this).data(n);r&&r[t].apply(r,Array.prototype.slice.call(i,1))}else new H(this,t)}),this)},e.fn.isValid=function(e,n){var r=q(this[0]),i,s;return r?(n===t&&(n=!0),r.checkOnly=n,i=this.is(":input")?this:this.find(m),s=r._multiValidate(i,function(t){N(e)&&e.call(null,t),r.checkOnly=!1}),N(e)?this:s):!0},e.expr[":"].verifiable=function(e){var t=e.nodeName.toLowerCase();return(t==="input"&&e.type!=="submit"&&e.type!=="button"&&e.type!=="reset"||t==="select"||t==="textarea")&&e.disabled===!1&&O(e,v)===null},H.prototype={_init:function(){var t=this,r=t.options,i=t.fields,s=t.$el[0];L(r.fields)&&e.each(r.fields,function(e,t){t&&(i[e]=k(t)?{rule:t}:t)}),C(r.groups)&&e.map(r.groups,function(n){if(!k(n.fields)||!N(n.callback))return null;var r=t.$el.find(I(n.fields)),s=function(){return n.callback.call(t,r)};e.extend(s,n),e.map(n.fields.split(" "),function(e){i[e]=i[e]||{},i[e].group=s})}),t.$el.find(m).each(function(){t._parse(this)}),t.msgOpt={type:"error",pos:W(r.msgClass),wrapper:r.msgWrapper,cls:r.msgClass,style:r.msgStyle,icon:r.msgIcon,arrow:r.msgArrow,show:r.msgShow,hide:r.msgHide};if(r.valid||O(s,"action")===null)t.isAjaxSubmit=!0;else{var o=e[e._data?"_data":"data"](s,"events");o&&o.valid&&e.map(o.valid,function(e){return e.namespace.indexOf("form")!==-1?1:null}).length?t.isAjaxSubmit=!0:t.isAjaxSubmit=!1}t.$el.data(n)||(t.$el.on("submit."+n+" validate."+n,T(t,"_submit")).on("reset."+n,T(t,"_reset")).on("showtip."+n,T(t,"_showTip")).on("validated.field."+n,m,T(t,"_validatedField")).on("validated.rule."+n,m,T(t,"_validatedRule")).on("focusin."+n+" click."+n+" showtip."+n,m,T(t,"_focus")).on("focusout."+n+" validate."+n,m,T(t,"_blur")).on("click."+n,"input:radio,input:checkbox",T(t,"_click")),r.timely>=2&&t.$el.on("keyup."+n+" paste."+n,m,T(t,"_blur")).on("change."+n,"select",T(t,"_click")),t.$el.data(n,t).addClass("n-"+n+" "+r.formClass),t.NOVALIDATE=O(s,v),O(s,v,v))},_multiValidate:function(n,r){var i=this,s=i.options;return i.isValid=!0,i.deferred={},s.ignore&&(n=n.not(s.ignore)),n.each(function(e,t){var n=i.getField(t);if(!n)return;i._validate(t,n);if(!i.isValid&&s.stopOnError)return!1}),e.when.apply(null,e.map(i.deferred,function(e){return e})).done(function(){r.call(i,i.isValid)}),e.isEmptyObject(i.deferred)?i.isValid:t},_submit:function(t,n){var r=this,i=r.options,s=t.target;if(_){_=!1;return}if(n==="only"||t.type==="validate"&&r.$el[0]!==s)return;t.preventDefault();if(r.submiting){N(r.submiting)&&r.submiting.call(r);return}if(N(i.beforeSubmit)&&i.beforeSubmit.call(r,s)===!1)return;r._reset(),r.submiting=!0,i.debug&&M.log("\n"+t.type+" form"),r._multiValidate(r.$el.find(m),function(t){var n="focus.field",o=t||i.debug===2?"valid":"invalid",u;if(!t){var f=r.$el.find(":input."+a+":first");f.trigger(n),A&&f.trigger(n),u=e.map(r.errors,function(e){return e})}r.submiting=!1,N(i[o])&&i[o].call(r,s,u),r.$el.trigger(o+".form",[s,u]),t&&!r.isAjaxSubmit&&(_=!0,s.submit())})},_reset:function(t){var n=this;n.errors={},t&&n.$el.find(m).each(function(t,r){n.hideMsg(r),O(r,d,null),O(r,l,null),e(r).removeClass(u+" "+a)})},_focus:function(e){var t=e.target,n;if(e.type!=="showtip"){if(e.isTrigger||this.submiting)return;if(t.value!==""&&(O(t,l)==="false"||O(t,d)==="tip"))return}n=O(t,p);if(!n)return;this.showMsg(t,{msg:n,type:"tip"})},_blur:function(t,n){var r=this,i=r.options,s,o,u=t.target,a=t.type,f=150;if(!n&&a!=="paste"){if(a==="validate")o=!0,f=0;else{if(O(u,"notimely"))return;if(i.timely>=2&&a!=="keyup")return}if(i.ignore&&e(u).is(i.ignore))return;if(a==="keyup"){var l=t.keyCode,c={8:1,9:1,16:1,32:1,46:1};if(l===9&&!u.value)return;if(l<48&&!c[l])return;f=i.timely>=100?i.timely:500}}s=r.getField(u);if(!s)return;f?(s.timeout&&clearTimeout(s.timeout),s.timeout=setTimeout(function(){r._validate(u,s,o)},f)):r._validate(u,s,o)},_click:function(e){this._blur(e,!0)},_showTip:function(e){var t=this;if(t.$el[0]!==e.target)return;t.$el.find(m+"["+p+"]").each(function(){t.showMsg(this,{msg:O(this,p),type:"tip"})})},_parse:function(e){var t=this,n,r=e.name,i=O(e,c);i&&O(e,c,null);if(e.id&&"#"+e.id in t.fields||!e.name)r="#"+e.id;if(!r)return;n=t.fields[r]||{},n.old={},n.rule=n.rule||i||"";if(!n.rule)return;n.key=r,n.required=n.rule.indexOf("required")!==-1,n.must=n.must||!!n.rule.match(/match|checked/),n.required&&O(e,"aria-required",!0),("timely"in n&&!n.timely||!t.options.timely)&&O(e,"notimely",!0),k(n.target)&&O(e,h,n.target),k(n.tip)&&O(e,p,n.tip),t.fields[r]=t._parseRule(n)},_parseRule:function(n){var r=y.exec(n.rule),i;if(!r)return;return n.display=r[1],n.rules=[],i=(r[2]||"").split(";"),e.map(i,function(r){var i=g.exec(r);if(!i)return null;i[3]&&(i[2]=i[3]),n.rules.push({method:i[1],params:i[2]?e.trim(i[2]).split(", "):t})}),n.vid=0,n.rid=n.rules[0].method,n},_validatedField:function(t,n,r){var i=this,s=i.options,o=t.target,f=r.isValid=n.isValid=!!r.isValid,c=f?"valid":"invalid";r.key=n.key,r.rule=n.rid,f?r.type="ok":(i.submiting&&(i.errors[n.key]=r.msg),i.isValid=!1),n.old.value=o.value,n.old.id=o.id,i.elements[n.key]=o;if(i.checkOnly)return;N(n[c])&&n[c].call(i,o,r),e(o).attr(l,!f).addClass(f?u:a).removeClass(f?a:u).trigger(c+".field",[r,i]);if(n.msgMaker||s.msgMaker)!r.showOk&&r.msg||r.showOk&&s.showOk!==!1?i.showMsg(o,r,n):i.hideMsg(o,r,n)},_validatedRule:function(n,r,i,s){var o=this,u=o.options,a=n.target,f="",l,c=!1,h=!1;s=s||{},r=r||o.getField(a),l=r.rid,i===null?e(a).trigger("validated.field",[r,{isValid:!0}]):i===!0||i===t?c=!0:(f=z(a,r,l),f||(k(i)?(f=i,i={error:f}):L(i)&&(i.error?f=i.error:(c=!0,i.ok&&k(i.ok)&&(h=!0),f=i.ok))),s.msg=(c?f:f||o.messages[l]||D.defaultMsg).replace("{0}",r.display||"")),u.debug&&M.log("   "+r.vid+": "+l+" => "+(s.msg||!0));if(c){s.isValid=!0;if(!h){var p=r.ok||O(a,"data-ok");p?(h=!0,s.msg=p):k(u.showOk)&&(h=!0,s.msg=u.showOk)}s.showOk=h,e(a).trigger("valid.rule",[l,s.msg])}else e(a).trigger("invalid.rule",[l,s.msg]);c&&r.vid<r.rules.length-1?(r.vid++,o._checkRule(a,r)):(r.vid=0,e(a).trigger("validated.field",[r,s]))},_checkRule:function(n,r){var i=this,s,o,u=r.key,a=r.rules[r.vid],f=a.method,l=a.params;if(i.submiting&&i.deferred[u])return;o=r.old,r.rid=f,!r.must&&o.ret!==t&&o.rule===a&&o.id===n.id&&n.value&&o.value===n.value?s=o.ret:s=(U(n,f)||i.rules[f]||function(){return!0}).call(i,n,l,r);if(L(s)&&N(s.then)){var c=function(e){if(k(e)||L(e)&&("error"in e||"ok"in e))return e};i.deferred[u]=s,!i.checkOnly&&i.showMsg(n,{type:"loading",msg:i.options.loadingMsg},r),s.then(function(s,u,f){var l=f.responseText,h,p=r.dataFilter||i.options.dataFilter;this.dataType==="json"?l=s:l.charAt(0)==="{"&&(l=e.parseJSON(l)||{}),N(p)?l=p(l):l===""?l=!0:(h=c(l),h===t&&(h=c(l.data)),l=h||!0),o.rule=a,o.ret=l,e(n).trigger("validated.rule",[r,l])},function(t,i){e(n).trigger("validated.rule",[r,i])}),r.isValid=t}else e(n).trigger("validated.rule",[r,s])},_validate:function(n,r){if(n.disabled||O(n,v)!==null)return;r.rules||this._parse(n);var i=this,s=i.options,o=e(n),u={},a=r.group,f,l=r.isValid=!0;s.debug&&M.info(r.key),a&&(f=a.call(i),f===!0||f===t?f=t:(k(f)&&(f={error:f}),r.vid=0,r.rid="group",l=!1,i.hideMsg(n,{},r),e.extend(u,a)));if(l&&!r.required&&!r.must&&!n.value){if(O(n,d)==="tip")return;if(!X(n)){o.trigger("validated.field",[r,{isValid:!0}]);return}}f!==t?o.trigger("validated.rule",[r,f,u]):r.rule&&i._checkRule(n,r)},_getMsgOpt:function(t){return e.extend({},this.msgOpt,k(t)?{msg:t}:t)},getField:function(e){var t=this,n;return e.id&&"#"+e.id in t.fields||!e.name?n="#"+e.id:n=e.name,O(e,c)&&t._parse(e),t.fields[n]},test:function(n,r){var i=this,s,o=g.exec(r),u,a;return o?(o[3]&&(o[2]=o[3]),u=o[1],a=o[2]?e.trim(o[2]).split(", "):t,u in i.rules&&(s=i.rules[u].call(i,n,a)),s===!0||s===t||s===null||!1):!0},getRangeMsg:function(e,t,n,r){if(!t)return;var i=this,s=i.messages[n]||"",o=t[0].split("~"),u=o[0],a=o[1],f="rg",l=[""],c=+e===+e;if(o.length===2){if(u&&a){if(c&&e>=+u&&e<=+a)return!0;l=l.concat(o)}else if(u&&!a){if(c&&e>=+u)return!0;l.push(u),f="gt"}else if(!u&&a){if(c&&e<=+a)return!0;l.push(a),f="lt"}}else{if(e===+u)return!0;l.push(u),f="eq"}return s&&(r&&s[f+r]&&(f+=r),l[0]=s[f]),i.renderMsg.apply(null,l)},renderMsg:function(){var e=arguments,t=e[0],n=e.length;if(!t)return;while(--n)t=t.replace("{"+n+"}",e[n]);return t},_getMsgDOM:function(t,n){var r=e(t),i,s,o;r.is(":input")?(o=n.target||O(t,h),o&&(o=this.$el.find(o),o.length&&(o.is(":input")?t=o.get(0):i=o)),i||(s=!X(t)&&t.id?t.id:t.name,i=this.$el.find(n.wrapper+"."+f+'[for="'+s+'"]'))):i=r;if(!i.length){r=this.$el.find(o||t),i=e("<"+n.wrapper+">").attr({"class":f+(n.cls?" "+n.cls:""),style:n.style||"","for":s});if(X(t)){var u=r.parent();i.appendTo(u.is("label")?u.parent():u)}else i[!n.pos||n.pos==="right"?"insertAfter":"insertBefore"](r)}return i},showMsg:function(t,n,r){n=this._getMsgOpt(n);if(!n.msg&&!n.showOk)return;t=e(t).get(0),e(t).is(m)&&(O(t,d,n.type),r=r||this.getField(t),r&&(r.msgStyle&&(n.style=r.msgStyle),r.msgClass&&(n.cls=r.msgClass),r.msgWrapper&&(n.wrapper=r.msgWrapper)));var i=this._getMsgDOM(t,n),s=i[0].className;!w.test(s)&&i.addClass(n.cls),A&&n.pos==="bottom"&&(i[0].style.marginTop=e(t).outerHeight()+"px"),i.html(((r||{}).msgMaker||this.options.msgMaker).call(this,n)),i[0].style.display="",N(n.show)&&n.show.call(this,i,n.type)},hideMsg:function(t,n,r){t=e(t).get(0),n=this._getMsgOpt(n),e(t).is(m)&&(r=r||this.getField(t),r&&r.msgWrapper&&(n.wrapper=r.msgWrapper));var i=this._getMsgDOM(t,n);if(!i.length)return;N(n.hide)?n.hide.call(this,i,n.type):i[0].style.display="none"},mapMsg:function(t){var n=this;e.each(t,function(e,t){var r=n.elements[e]||n.$el.find(':input[name="'+e+'"]')[0];n.showMsg(r,t)})},setMsg:function(e){new j(e,this.messages)},setRule:function(t){new B(t,this.rules),e.map(this.fields,function(e){e.old={}})},setField:function(t,n){var r=this,i={};if(k(t)){if(n===null){e.map(t.split(" "),function(e){e&&r.fields[e]&&(r.fields[e]=null)});return}n&&(i[t]=n)}else L(t)&&(i=t);r.options.fields?e.extend(r.options.fields,i):r.options.fields=i,r._init()},holdSubmit:function(e){e===t&&(e=!0),this.submiting=e},destroy:function(){this._reset(!0),this.$el.off("."+n).removeData(n),O(this.$el[0],v,this.NOVALIDATE)}},e(document).on("focusin",":input["+c+"]",function(){R(this,"focusin")}).on("click","input,button",function(){if(!this.form)return;if(this.type==="submit")O(this,v)!==null&&(_=!0);else if(this.name&&X(this)){var e=this.form.elements[this.name];e.length&&(e=e[0]),O(e,c)&&R(e,"validate")}}).on("submit","form",function(t){if(O(this,v)!==null)return;var r=e(this),i;r.data(n)||(i=r[n]().data(n),e.isEmptyObject(i.fields)?(O(this,v,v),r.off("."+n).removeData(n)):t.type==="submit"&&i._submit(t))}),new B({required:function(t,n){var r=e.trim(t.value),i=!0;if(n)if(n.length===1){if(!r&&!this.test(t,n[0]))return null}else n[0]==="not"&&e.map(n.slice(1),function(t){r===e.trim(t)&&(i=!1)});return i&&!!r},integer:function(e,t){var n,r="0|",i="[1-9]\\d*",s=t?t[0]:"*";switch(s){case"+":n=i;break;case"-":n="-"+i;break;case"+0":n=r+i;break;case"-0":n=r+"-"+i;break;default:n=r+"-?"+i}return n="^(?:"+n+")$",(new RegExp(n)).test(e.value)||this.messages.integer[s]},match:function(t,r,i){if(!r)return;var s,o,u,a,f="eq",l,c,h;r.length===1?u=r[0]:(f=r[0],u=r[1]),l=u.charAt(0)==="#"?u:':input[name="'+u+'"]',c=this.$el.find(l)[0];if(!c)return;h=this.getField(c),s=t.value,o=c.value,i.init_match||(this.$el.on("valid.field."+n,l,function(){e(t).trigger("validate")}),i.init_match=h.init_match=1);if(!i.required&&s===""&&o==="")return null;r[2]&&(r[2]==="date"?(s=V(s),o=V(o)):r[2]==="time"&&(s=+s.replace(":",""),o=+o.replace(":","")));if(f!=="eq"&&!isNaN(+s)&&isNaN(+o))return!0;a=this.messages.match[f].replace("{1}",h.display||u);switch(f){case"lt":return+s<+o||a;case"lte":return+s<=+o||a;case"gte":return+s>=+o||a;case"gt":return+s>+o||a;case"neq":return s!==o||a;default:return s===o||a}},range:function(e,t){return this.getRangeMsg(+e.value,t,"range")},checked:function(t,n,r){if(!X(t))return;var i,s;return s=this.$el.find('input[name="'+t.name+'"]').filter(function(){return!i&&X(this)&&(i=this),!this.disabled&&this.checked&&e(this).is(":visible")}).length,n?this.getRangeMsg(s,n,"checked"):!!s||z(i,r,"checked")||this.messages.required},length:function(e,t){var n=e.value,r=(t[1]?n.replace(b,"xx"):n).length;return t&&t[0].charAt(0)==="~"&&(t[0]="0"+t[0]),this.getRangeMsg(r,t,"length",t[1]?"_2":"")},remote:function(t,n){if(!n)return;var r=this,i=E.exec(n[0]),s=i[2],o=(i[1]||"POST").toUpperCase(),u,a={};return a[t.name]=t.value,n[1]&&e.map(n.slice(1),function(t){a[e.trim(t)]=r.$el.find(':input[name="'+t+'"]').val()}),a=e.param(a),o==="POST"&&(u=s.indexOf("?"),u!==-1&&(a+="&"+s.substring(u+1,s.length),s=s.substring(0,u))),e.ajax({url:s,type:o,data:a,async:!0,cache:!1})},filter:function(e,t){e.value=e.value.replace(t?new RegExp("["+t[0]+"]","g"):S,"")}}),H.config=function(t){e.each(t,function(e,t){e==="rules"?new B(t):e==="messages"?new j(t):D[e]=t})},H.setTheme=function(t,n){L(t)?e.each(t,function(e,t){P[e]=t}):k(t)&&L(n)&&(P[t]=n)},e[n]=H})(jQuery)